"use strict";exports.id=583,exports.ids=[583],exports.modules={8279:(a,b,c)=>{c.d(b,{KG:()=>f,Ks:()=>e,gM:()=>d,pt:()=>g});var d=function(a){return a.PRS="PRS",a.PEB="PEB",a.MPB="MPB",a.MXB="MXB",a.UB="UB",a.PASSERELLE="PASSERELLE",a.AUTRE="AUTRE",a}({}),e=function(a){return a.DONE="DONE",a.CURRENT="CURRENT",a.PROSPECT="PROSPECT",a}({}),f=function(a){return a.PLAN="PLAN",a.FLAG="FLAG",a.CLIENT_LOGO="CLIENT_LOGO",a.PIN="PIN",a.OTHER="OTHER",a}({}),g=function(a){return a.IMAGE="IMAGE",a.DOCUMENT="DOCUMENT",a.VIDEO="VIDEO",a.AUDIO="AUDIO",a.ARCHIVE="ARCHIVE",a.OTHER="OTHER",a}({})},27583:(a,b,c)=>{c.d(b,{gG:()=>k,j2:()=>o,R1:()=>l,Y9:()=>n});var d=c(89353),e=c(99306),f=c(91132),g=c(96832),h=c(48689),i=c(32146),j=c(38629);let k={ADMIN:"ADMIN",USER:"USER",VISITOR:"VISITOR"};function l(a,b){return!!a?.user?.role&&b.includes(a.user.role)}var m=c(30477);m.vF.debug("[AUTH_INIT] NextAuth config - AUTH_SECRET exists:",!!process.env.AUTH_SECRET),m.vF.debug("[AUTH_INIT] NextAuth config - NODE_ENV:","production");let{handlers:n,auth:o,signIn:p,signOut:q}=(0,d.Ay)({session:{strategy:"jwt"},secret:process.env.AUTH_SECRET,trustHost:!0,pages:{signIn:"/login"},providers:[(0,e.A)({name:"Credentials",credentials:{username:{label:"Nom d'utilisateur",type:"text"},password:{label:"Mot de passe",type:"password"}},async authorize(a){m.vF.debug("[AUTH_FLOW] Authorize callback started for:",a?.username),m.vF.debug("[Auth_Authorize] Attempting login for user/email:",a?.username);try{let b=j.Ikc({username:j.YjP(),password:j.YjP().min(6)}).safeParse(a);if(!b.success)return m.vF.warn("[Auth_Authorize] Invalid credentials format provided",{errors:b.error.issues,received:{username:a?.username?String(a.username).substring(0,3)+"...":void 0,passwordLength:a?.password?String(a.password).length:0}}),null;let{username:c,password:d}=b.data;m.vF.debug("[Auth_Authorize] Querying database for user:",c);let[e]=await f.db.select().from(g.users).where((0,h.or)((0,h.eq)(g.users.username,c),(0,h.eq)(g.users.email,c))).limit(1);if(!e)return m.vF.warn("[Auth_Authorize] USER NOT FOUND in database:",c),null;if(!e.passwordHash)return m.vF.error("[Auth_Authorize] CRITICAL: User has NO password hash set:",c),null;if(m.vF.debug("[Auth_Authorize] User found, verifying password hash..."),(0,i.Dm)(d,e.passwordHash))return m.vF.info("[Auth_Authorize] SUCCESS: Password match successful for:",c),{id:e.id,username:e.username,email:e.email,name:e.name,role:e.role,color:e.color,passwordHash:e.passwordHash,createdAt:e.createdAt?.toISOString()??null,updatedAt:e.updatedAt?.toISOString()??null};m.vF.warn("[Auth_Authorize] FAILURE: Password mismatch for user:",c)}catch(a){m.vF.error("[Auth_Authorize] CRITICAL ERROR during authorization process:",{error:a,name:a.name,message:a.message,code:a.code,meta:a.meta})}return null}})],callbacks:{async jwt({token:a,user:b,trigger:c,account:d}){try{return m.vF.debug("[Auth_JWT] JWT callback triggered",{trigger:c,hasUser:!!b,account:d?.provider}),b&&(m.vF.debug("[Auth_JWT] Adding user data to token",{userId:b.id,username:b.username,role:b.role}),a.id=b.id,a.role=b.role,a.username=b.username,a.name=b.name,a.color=b.color),m.vF.debug("[Auth_JWT] Returning token",{tokenId:a.id}),a}catch(a){throw m.vF.error("[Auth_JWT] JWT callback error:",a),a}},async session({session:a,token:b,trigger:c}){try{return m.vF.debug("[Auth_Session] Session callback triggered",{trigger:c}),a.user&&(a.user.id=b.id,a.user.role=b.role,a.user.username=b.username,a.user.name=b.name,a.user.color=b.color,m.vF.debug("[Auth_Session] Session populated with user data",{userId:a.user.id,username:a.user.username})),a}catch(a){throw m.vF.error("[Auth_Session] Session callback error:",a),a}}}})},30477:(a,b,c)=>{c.d(b,{vF:()=>e}),c(74515);let d="true"===process.env.DEBUG_LOGS,e={debug:(...a)=>{d&&console.log("[DEBUG]",...a)},info:(...a)=>{d&&console.info("[INFO]",...a)},warn:(...a)=>{console.warn("[WARN]",...a)},error:(...a)=>{console.error("[ERROR]",...a)}}},91132:(a,b,c)=>{let d;c.d(b,{db:()=>h});var e=c(15191),f=c(9608),g=c(96832);let h=new Proxy({},{get:(a,b)=>(function(){if(d)return d;let a=(()=>{if(process.env.DATABASE_URL)return process.env.DATABASE_URL;let a=globalThis;return a.__env?.DATABASE_URL?a.__env.DATABASE_URL:a.env?.DATABASE_URL?a.env.DATABASE_URL:a.DATABASE_URL?a.DATABASE_URL:void 0})();if(!a)throw Error("DATABASE_URL environment variable is not set");let b=(0,f.lw)(a);return d=(0,e.fd)(b,{schema:g})})()[b]})},96832:(a,b,c)=>{c.r(b),c.d(b,{DocumentType:()=>I.KG,FileType:()=>I.pt,ProjectStatus:()=>I.Ks,ProjectType:()=>I.gM,documentTypeEnum:()=>h,documents:()=>y,documentsRelations:()=>G,fileTypeEnum:()=>i,files:()=>z,filesRelations:()=>H,images:()=>t,imagesRelations:()=>D,projectStatusEnum:()=>g,projectTypeEnum:()=>f,projects:()=>s,projectsRelations:()=>C,slideshowImages:()=>w,slideshowImagesRelations:()=>E,userRoleEnum:()=>e,users:()=>n,usersRelations:()=>B,videos:()=>x,videosRelations:()=>F});var d=c(75947);let e=(0,d.rL)("user_role",["USER","ADMIN","VISITOR"]),f=(0,d.rL)("project_type",["PRS","PEB","MPB","MXB","UB","PASSERELLE","AUTRE"]),g=(0,d.rL)("project_status",["DONE","CURRENT","PROSPECT"]),h=(0,d.rL)("document_type",["PLAN","FLAG","CLIENT_LOGO","OTHER","PIN"]),i=(0,d.rL)("file_type",["IMAGE","DOCUMENT","VIDEO","AUDIO","ARCHIVE","OTHER"]);var j=c(22672),k=c(29745),l=c(62352),m=c(27170);let n=(0,j.cJ)("users",{id:(0,k.Qq)("id").primaryKey().$defaultFn(()=>(0,m.sX)()),email:(0,k.Qq)("email").unique(),name:(0,k.Qq)("name"),passwordHash:(0,k.Qq)("passwordHash").notNull(),role:e("role").default("USER").notNull(),createdAt:(0,l.vE)("createdAt").defaultNow().notNull(),updatedAt:(0,l.vE)("updatedAt").defaultNow().notNull(),username:(0,k.Qq)("username").unique(),color:(0,k.Qq)("color").default("#6366f1")});var o=c(57789),p=c(79634),q=c(84266),r=c(65828);let s=(0,j.cJ)("projects",{id:(0,k.Qq)("id").primaryKey().$defaultFn(()=>(0,m.sX)()),name:(0,o.yf)("name",{length:255}).notNull(),country:(0,o.yf)("country",{length:255}).notNull(),latitude:(0,p.x)("latitude").notNull(),longitude:(0,p.x)("longitude").notNull(),description:(0,k.Qq)("description"),type:f("type").notNull(),status:g("status").default("PROSPECT").notNull(),prospection:(0,q.nd)("prospection").default(0).notNull(),studies:(0,q.nd)("studies").default(0).notNull(),fabrication:(0,q.nd)("fabrication").default(0).notNull(),transport:(0,q.nd)("transport").default(0).notNull(),construction:(0,q.nd)("construction").default(0).notNull(),projectCode:(0,o.yf)("projectCode",{length:255}),createdAt:(0,l.vE)("createdAt").defaultNow().notNull(),updatedAt:(0,l.vE)("updatedAt").defaultNow().notNull(),ownerId:(0,k.Qq)("ownerId").notNull()},a=>({countryIdx:(0,r.Pe)().on(a.country),typeIdx:(0,r.Pe)().on(a.type),statusIdx:(0,r.Pe)().on(a.status)})),t=(0,j.cJ)("images",{id:(0,k.Qq)("id").primaryKey().$defaultFn(()=>(0,m.sX)()),url:(0,k.Qq)("url").notNull(),alt:(0,k.Qq)("alt"),order:(0,q.nd)("order").default(0).notNull(),projectId:(0,k.Qq)("projectId").notNull(),createdAt:(0,l.vE)("createdAt").defaultNow().notNull()},a=>({projectIdx:(0,r.Pe)().on(a.projectId)}));var u=c(4396),v=c(72965);let w=(0,j.cJ)("slideshow_images",{id:(0,k.Qq)("id").primaryKey().$defaultFn(()=>(0,m.sX)()),projectId:(0,k.Qq)("projectId").notNull(),imageId:(0,k.Qq)("imageId").notNull(),order:(0,q.nd)("order").default(0).notNull(),isPublished:(0,u.zM)("isPublished").default(!1).notNull(),createdAt:(0,l.vE)("createdAt").defaultNow().notNull(),updatedAt:(0,l.vE)("updatedAt").defaultNow().notNull()},a=>({projectOrderIdx:(0,r.Pe)().on(a.projectId,a.order),projectPublishedIdx:(0,r.Pe)().on(a.projectId,a.isPublished),projectImageUnique:(0,v.Am)().on(a.projectId,a.imageId)})),x=(0,j.cJ)("videos",{id:(0,k.Qq)("id").primaryKey().$defaultFn(()=>(0,m.sX)()),url:(0,k.Qq)("url").notNull(),title:(0,k.Qq)("title"),projectId:(0,k.Qq)("projectId").notNull(),createdAt:(0,l.vE)("createdAt").defaultNow().notNull(),isPublished:(0,u.zM)("isPublished").default(!1).notNull(),order:(0,q.nd)("order").default(0).notNull(),updatedAt:(0,l.vE)("updatedAt").defaultNow().notNull()},a=>({projectOrderIdx:(0,r.Pe)().on(a.projectId,a.order)})),y=(0,j.cJ)("documents",{id:(0,k.Qq)("id").primaryKey().$defaultFn(()=>(0,m.sX)()),url:(0,k.Qq)("url").notNull(),name:(0,k.Qq)("name").notNull(),type:h("type").notNull(),projectId:(0,k.Qq)("projectId").notNull(),createdAt:(0,l.vE)("createdAt").defaultNow().notNull()},a=>({projectIdx:(0,r.Pe)().on(a.projectId)})),z=(0,j.cJ)("files",{id:(0,k.Qq)("id").primaryKey().$defaultFn(()=>(0,m.sX)()),name:(0,k.Qq)("name").notNull(),blobUrl:(0,k.Qq)("blobUrl").notNull().unique(),blobPath:(0,k.Qq)("blobPath").notNull(),fileType:i("fileType").notNull(),mimeType:(0,k.Qq)("mimeType").notNull(),size:(0,q.nd)("size").notNull(),projectId:(0,k.Qq)("projectId"),thumbnailUrl:(0,k.Qq)("thumbnailUrl"),width:(0,q.nd)("width"),height:(0,q.nd)("height"),duration:(0,q.nd)("duration"),isDeleted:(0,u.zM)("isDeleted").default(!1).notNull(),deletedAt:(0,l.vE)("deletedAt"),deletedBy:(0,k.Qq)("deletedBy"),createdAt:(0,l.vE)("createdAt").defaultNow().notNull(),updatedAt:(0,l.vE)("updatedAt").defaultNow().notNull()},a=>({projectIdx:(0,r.Pe)().on(a.projectId),deletedIdx:(0,r.Pe)().on(a.isDeleted),fileTypeIdx:(0,r.Pe)().on(a.fileType)}));var A=c(98445);let B=(0,A.K1)(n,({many:a})=>({projects:a(s)})),C=(0,A.K1)(s,({one:a,many:b})=>({owner:a(n,{fields:[s.ownerId],references:[n.id]}),documents:b(y),files:b(z),images:b(t),slideshowImages:b(w),videos:b(x)})),D=(0,A.K1)(t,({one:a,many:b})=>({project:a(s,{fields:[t.projectId],references:[s.id]}),slideshowImages:b(w)})),E=(0,A.K1)(w,({one:a})=>({image:a(t,{fields:[w.imageId],references:[t.id]}),project:a(s,{fields:[w.projectId],references:[s.id]})})),F=(0,A.K1)(x,({one:a})=>({project:a(s,{fields:[x.projectId],references:[s.id]})})),G=(0,A.K1)(y,({one:a})=>({project:a(s,{fields:[y.projectId],references:[s.id]})})),H=(0,A.K1)(z,({one:a})=>({project:a(s,{fields:[z.projectId],references:[s.id]})}));var I=c(8279)}};